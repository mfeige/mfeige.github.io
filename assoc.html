<!doctype html>
<html>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Associate</title>
		<style>
			html,
			body {
				margin: 0;
				padding: 0;
				width: 100%;
				overflow-x: hidden;
				font-family: sans-serif;
				text-align: center;
			}

			#setup {
				margin: 10px auto;
				display: inline-block;
				max-width: 95vw;
			}
			textarea {
				width: 95vw;
				max-width: 240px;
				height: 120px;
				font-size: 16px;
				display: block;
				margin: 0 auto 10px auto;
				box-sizing: border-box;
			}
			select,
			button {
				margin-top: 10px;
				padding: 8px 12px;
				font-size: 16px;
			}
			table {
				margin: 20px auto;
				border-spacing: 10px; /* space between cells */
			}
			td {
				width: 120px;
				height: 80px;
				text-align: center;
			}
			.card {
				border: 1px solid #333;
				padding: 20px;
				background: #eee;
				border-radius: 8px;
				font-size: 18px;
				user-select: none;
			}
			.card.selected {
				background: #add8e6;
			}
			.found {
				background: #8f8;
				visibility: hidden;
			}

			#controls {
				margin-top: 15px;
			}
			#controls button {
				margin: 5px;
			}

			h2 {
				margin-top: 20px;
			}
		</style>
	</head>
	<body>
		<div id="setup">
			<p>Enter word pairs, one per row:</p>
			<textarea id="wordInput" placeholder=""></textarea><br />
			<label for="delimiter">Delimiter:</label>
			<select id="delimiter">
				<option value=",">Comma (,)</option>
				<option value=";">Semicolon (;)</option>
				<option value="tab">Tab</option></select
			><br />
			<button id="startBtn">Start</button>
		</div>

		<div id="game" style="display: none">
			<div id="controls"></div>
			<div class="grid" id="grid"></div>
			<h2>Found pairs</h2>
			<ol id="found"></ol>
		</div>

		<script>
			let allPairs = [];
			let currentSet = 0;
			let sets = [];
			let delimiter = "";

			function shuffleArray(array) {
				for (var i = array.length - 1; i > 0; i--) {
					var j = Math.floor(Math.random() * (i + 1));
					var temp = array[i];
					array[i] = array[j];
					array[j] = temp;
				}
			}

			function partitionPairs(pairs, maxPairs = 5) {
				let totalPairs = pairs.length;
				let numSets = Math.ceil(totalPairs / maxPairs);
				let minPerSet = Math.floor(totalPairs / numSets);
				let largeSets = totalPairs - numSets * minPerSet;

				let result = [];
				let index = 0;
				let pairsRemaining = totalPairs;

				for (let i = 0; i < numSets; i++) {
					let pairCount = minPerSet;
					if (i < largeSets) {
						pairCount += 1;
					}
					result.push(pairs.slice(index, index + pairCount));
					index += pairCount;
				}
				return result;
			}

			function getParts(pair) {
				return pair
					.split(delimiter)
					.map((s) => s.trim())
					.filter(Boolean);
			}

			function startGame() {
				const input = document.getElementById("wordInput").value.trim();
				const delimiterChoice =
					document.getElementById("delimiter").value;

				if (!input) {
					alert("Please insert word pairs!");
					return;
				}

				delimiter = delimiterChoice === "tab" ? /\t/ : delimiterChoice;

				allPairs = [];
				input.split(/\n/).forEach((line) => {
					let parts = getParts(line);
					if (parts.length === 2) allPairs.push(line);
				});

				if (allPairs.length === 0) {
					alert("No valid word pairs found!");
					return;
				}

				shuffleArray(allPairs);

				sets = partitionPairs(allPairs, 5);
				currentSet = 0;

				document.getElementById("setup").style.display = "none";
				document.getElementById("game").style.display = "block";

				loadSet(currentSet);
			}

			function loadSet(index) {
				let table = document.getElementById("grid");
				let foundList = document.getElementById("found");
				let controls = document.getElementById("controls");

				table.innerHTML = "";
				foundList.innerHTML = "";
				controls.innerHTML = "";

				if (index >= sets.length) {
					table.style.display = "none";
					let doneMsg = document.createElement("p");
					doneMsg.innerHTML = "<b>Fertig ðŸŽ‰</b>";
					controls.appendChild(doneMsg);

					let restartBtn = document.createElement("button");
					restartBtn.textContent = "Neustart";
					restartBtn.onclick = () => {
						document.getElementById("setup").style.display =
							"block";
						document.getElementById("game").style.display = "none";
						document.getElementById("wordInput").value = "";
						table.style.display = "table";
					};
					controls.appendChild(restartBtn);
					return;
				}

				let pairs = sets[index];
				let cards1 = [];
				let cards2 = [];
				pairs.forEach((pair) => {
					let parts = getParts(pair);
					cards1.push(parts[0]);
					cards2.push(parts[1]);
				});
				shuffleArray(cards1);
				shuffleArray(cards2);
				let cards = [];
				for (let i = 0; i < pairs.length; i += 1) {
					cards.push(cards1[i]);
					cards.push(cards2[i]);
				}

				let selected = [];
				for (let i = 0; i < cards.length; i += 2) {
					let tr = document.createElement("tr");

					for (let j = 0; j < 2; j++) {
						let td = document.createElement("td");
						if (i + j < cards.length) {
							let word = cards[i + j];
							let div = document.createElement("div");
							div.className = "card";
							div.textContent = word;
							div.dataset.word = word;

							div.addEventListener("click", () => {
								if (
									div.classList.contains("found") ||
									div.classList.contains("selected")
								)
									return;

								div.classList.add("selected");
								selected.push(div);

								if (selected.length === 2) {
									let [c1, c2] = selected;
									let match = pairs.find(
										(p) =>
											p.includes(c1.dataset.word) &&
											p.includes(c2.dataset.word),
									);

									if (match) {
										setTimeout(() => {
											c1.classList.add("found");
											c2.classList.add("found");
											let li =
												document.createElement("li");
											let parts = getParts(match);
											li.textContent =
												parts[0] + " â†” " + parts[1];
											foundList.appendChild(li);

											if (
												[
													...table.querySelectorAll(
														".card:not(.found)",
													),
												].length === 0
											) {
												table.style.display = "none";
												let nextBtn =
													document.createElement(
														"button",
													);
												nextBtn.textContent =
													index + 1 < sets.length
														? "Next"
														: "Finished";
												nextBtn.onclick = () => {
													table.style.display =
														"table";
													loadSet(index + 1);
												};
												controls.appendChild(nextBtn);
											}
										}, 300);
									} else {
										setTimeout(() => {
											c1.classList.remove("selected");
											c2.classList.remove("selected");
										}, 600);
									}
									selected = [];
								}
							});

							td.appendChild(div);
						}
						tr.appendChild(td);
					}
					table.appendChild(tr);
				}
			}

			document
				.getElementById("startBtn")
				.addEventListener("click", startGame);
		</script>
	</body>
</html>
