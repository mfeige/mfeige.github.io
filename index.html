<!doctype html>
<html>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Practice</title>
		<style>
			html,
			body {
				margin: 0;
				padding: 0;
				width: 100%;
				overflow-x: hidden;
				font-family: sans-serif;
				text-align: center;
			}

			#setup {
				display: inline-block;
				margin: 10px auto;
				max-width: 95vw;
			}
			#navigation {
				display: none;
				margin: 10px auto;
				max-width: 95vw;
			}
			#navigationButtons {
				display: flex;
				gap: 10px;
				max-width: 500px;
				justify-content: center;
			}
			.navigationBtn {
				font-size: 32px;
				flex: 1;
				align-items: stretch;
			}
			textarea {
				width: 95vw;
				max-width: 240px;
				height: 120px;
				font-size: 16px;
				display: block;
				margin: 0 auto 10px auto;
				box-sizing: border-box;
			}
			select,
			button {
				margin-top: 10px;
				padding: 8px 12px;
				font-size: 16px;
			}
			table {
				border-collapse: separate;
				margin: 20px auto;
				width: auto; /* table fits viewport width */
				max-width: 500px; /* optional limit for desktop */
			}

			td {
				width: 50%;
				padding: 6px;
				box-sizing: border-box;
			}

			.card {
				width: 100%; /* card fills td */
				border: 1px solid #333;
				border-radius: 8px;
				background: #eee;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: clamp(14px, 5vw, 20px);
				user-select: none;
				box-sizing: border-box;
				padding: 10px;
			}
			.card.selected {
				background: #add8e6;
			}
			.found {
				background: #8f8;
				visibility: hidden;
			}

			#controls {
				margin-top: 15px;
			}
			#controls button {
				margin: 5px;
			}

			h2 {
				margin-top: 20px;
			}

			#found {
				width: auto; /* only as wide as needed */
				display: table; /* shrink-to-fit trick */
				margin: 0 auto; /* center horizontally */
				text-align: left; /* align text with numbers */
				padding-left: 1.5em; /* keep number indentation */
			}

			#found li {
				margin: 4px 0;
			}
		</style>
	</head>
	<body>
		<div id="setup" data-display="block">
			<p>Enter word pairs, one per row:</p>
			<textarea autofocus id="wordInput" placeholder=""></textarea><br />
			<label for="delimiter">Delimiter:</label>
			<select id="delimiter">
				<option value=",">Comma (,)</option>
				<option value=";">Semicolon (;)</option>
				<option value="tab">Tab</option>
			</select>
			<br />
			<button onclick="importPairs();">Import</button>
		</div>
		<br />

		<div id="navigation" data-display="flex">
			<p id="finished"><b>Finished ðŸŽ‰</b></p>
			<p id="navigationHeader"></p>
			<p>Choose the method to practice:</p>
			<div style="display: inline-block">
				<div id="navigationButtons">
					<button class="navigationBtn" onclick="practice(0);">
						âŸº
					</button>
					<button class="navigationBtn" onclick="practice(1);">
						âŸ¹
					</button>
					<button class="navigationBtn" onclick="practice(2);">
						âŸ¸
					</button>
					<button
						id="newInput"
						class="navigationBtn"
						onclick="showSetup();"
						style.display="none"
					>
						New
					</button>
				</div>
			</div>
		</div>
		<br />

		<div id="practice" style="display: none" data-display="block">
			<div id="controls">
				<button id="nextBtn" onClick="nextSet();">Next</button>
			</div>
			<table id="grid"></table>
			<ol id="found"></ol>
		</div>

		<script>
			let g_allPairs = [];
			let g_setIndex = 0;
			let g_sets = [];
			let g_delimiter = "";
			let g_mode = 0;
			let g_selected = [];

			function shuffleArray(array) {
				for (var i = array.length - 1; i > 0; i--) {
					var j = Math.floor(Math.random() * (i + 1));
					var temp = array[i];
					array[i] = array[j];
					array[j] = temp;
				}
			}

			function partitionPairs(pairs, maxPairs = 5) {
				let totalPairs = pairs.length;
				let numg_sets = Math.ceil(totalPairs / maxPairs);
				let minPerSet = Math.floor(totalPairs / numg_sets);
				let largeg_sets = totalPairs - numg_sets * minPerSet;

				let result = [];
				let index = 0;
				let pairsRemaining = totalPairs;

				for (let i = 0; i < numg_sets; i++) {
					let pairCount = minPerSet;
					if (i < largeg_sets) {
						pairCount += 1;
					}
					result.push(pairs.slice(index, index + pairCount));
					index += pairCount;
				}
				return result;
			}

			function getParts(pair) {
				return pair
					.split(g_delimiter)
					.map((s) => s.trim())
					.filter(Boolean);
			}

			function showTopDiv(id) {
				const divIds = ["setup", "navigation", "practice"];
				divIds.forEach((divId) => {
					let div = document.getElementById(divId);
					div.style.display = divId == id ? "block" : "none";
				});
			}

			function showSetup() {
				showTopDiv("setup");
				let wordInput = document.getElementById("wordInput");
				wordInput.value = "";
				wordInput.focus();
				document.addEventListener("keydown", handleKeydownSetup);
			}

			function handleKeydownSetup() {
				if (event.ctrlKey && event.key == "Enter") {
					event.preventDefault();
					importPairs();
				}
			}

			function importPairs() {
				const input = document.getElementById("wordInput").value.trim();
				const delimiterChoice =
					document.getElementById("delimiter").value;

				if (!input) {
					alert("Please insert word pairs!");
					return;
				}

				g_delimiter = delimiterChoice == "tab" ? /\t/ : delimiterChoice;

				g_allPairs = [];
				input.split(/\n/).forEach((line) => {
					let parts = getParts(line);
					if (parts.length == 2) g_allPairs.push(line);
				});
				if (g_allPairs.length == 0) {
					alert("No valid word pairs found!");
					return;
				}
				document.removeEventListener("keydown", handleKeydownSetup);
				showNavigation();
			}

			function showNavigation(showFinished = false) {
				showTopDiv("navigation");
				document.getElementById("finished").style.display = showFinished
					? "block"
					: "none";
				let pairText =
					g_allPairs.length == 1
						? "1 pair"
						: g_allPairs.length + " pairs";
				document.getElementById("navigationHeader").innerHTML =
					pairText + " loaded";
			}

			function practice(mode) {
				g_mode = mode;

				shuffleArray(g_allPairs);

				g_sets = partitionPairs(g_allPairs);
				g_setIndex = 0;
				showTopDiv("practice");
				loadSet();
			}

			function onClickMatch(div) {
				if (
					div.classList.contains("found") ||
					div.classList.contains("selected")
				)
					return;

				div.classList.add("selected");
				let table = document.getElementById("grid");
				let selected = [...table.querySelectorAll(".card.selected")];

				if (selected.length != 2) {
					return;
				}

				let pairs = g_sets[g_setIndex];
				let [c1, c2] = selected;
				let match = pairs.find(
					(p) =>
						p.includes(c1.dataset.word) &&
						p.includes(c2.dataset.word),
				);

				if (match) {
					setTimeout(() => {
						c1.classList.add("found");
						c2.classList.add("found");
						c1.classList.remove("selected");
						c2.classList.remove("selected");
						let li = document.createElement("li");
						let parts = getParts(match);
						li.textContent = parts[0] + " â†” " + parts[1];
						document.getElementById("found").appendChild(li);
						let table = document.getElementById("grid");
						if (
							[...table.querySelectorAll(".card:not(.found)")]
								.length == 0
						) {
							table.style.display = "none";
							showNextBtn();
						}
					}, 300);
				} else {
					setTimeout(() => {
						c1.classList.remove("selected");
						c2.classList.remove("selected");
					}, 600);
				}
				selected = [];
			}

			function onClickReveal(div) {
				const j = div.dataset.j;
				if (j == 2 - g_mode) {
					const hidden = div.dataset.hide == "true";
					div.dataset.hide = hidden ? "false" : true;
					updateDivContent(div);
					const divMatch = document.getElementById(
						"card_" + div.dataset.i + "_" + (1 - j),
					);
					if (hidden) {
						div.classList.add("revealed");
						divMatch.classList.add("revealed");
					} else {
						div.classList.remove("revealed");
						divMatch.classList.remove("revealed");
					}
				}
				let table = document.getElementById("grid");
				if (
					[...table.querySelectorAll(".card:not(.revealed)")]
						.length == 0
				) {
					showNextBtn();
				}
			}

			function updateDivContent(div) {
				if (div.dataset.hide == "true") {
					div.textContent = "?";
				} else {
					div.textContent = div.dataset.word;
				}
			}

			function loadSet() {
				let table = document.getElementById("grid");
				let foundList = document.getElementById("found");

				table.innerHTML = "";
				foundList.innerHTML = "";
				document.getElementById("nextBtn").style.display = "none";

				if (g_setIndex >= g_sets.length) {
					showNavigation(true);

					document.getElementById("finished").style.display = "block";
					document.getElementById("navigation").style.display =
						"block";
					return;
				}

				let cards1 = [];
				let cards2 = [];
				let pairs = g_sets[g_setIndex];
				pairs.forEach((pair) => {
					let parts = getParts(pair);
					cards1.push(parts[0]);
					cards2.push(parts[1]);
				});
				if (g_mode == 0) {
					shuffleArray(cards1);
					shuffleArray(cards2);
				}
				let cards = [];
				for (let i = 0; i < pairs.length; i += 1) {
					cards.push(cards1[i]);
					cards.push(cards2[i]);
				}

				let selected = [];
				for (let i = 0; i < cards.length; i += 2) {
					let tr = document.createElement("tr");

					for (let j = 0; j < 2; j++) {
						let td = document.createElement("td");
						let word = cards[i + j];
						let div = document.createElement("div");
						div.id = "card_" + i + "_" + j;
						div.className = "card";
						div.dataset.word = word;
						div.dataset.i = i;
						div.dataset.j = j;
						div.dataset.hide = g_mode > 0 && j == 2 - g_mode;
						updateDivContent(div);

						div.addEventListener("click", () => {
							if (g_mode == 0) {
								onClickMatch(div);
								return;
							} else {
								onClickReveal(div);
							}
						});

						td.appendChild(div);

						tr.appendChild(td);
					}
					table.appendChild(tr);
				}
			}

			function showNextBtn() {
				document.getElementById("nextBtn").style.display =
					"inline-block";
			}

			function nextSet() {
				document.getElementById("grid").style.display = "table";
				g_setIndex = g_setIndex + 1;
				loadSet();
			}

			window.addEventListener("DOMContentLoaded", () => {
				const params = new URLSearchParams(window.location.search);
				g_delimiter = params.get("delimiter") || ",";
				let pairsParam = params.get("pairs") || "";
				if (pairsParam) {
					pairsParam
						.split("|")
						.forEach((pair) => g_allPairs.push(pair));
				}
				document.addEventListener("keydown", handleKeydownSetup);
				if (g_allPairs.length > 0) {
					showNavigation();
				}
			});
		</script>
	</body>
</html>
